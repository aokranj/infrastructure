<VirtualHost *:80>
    # This setting usually does not contain the protocol part (and "https" on
    # port 80 makes no sense), but mod_auth_mellon is constructing URLs from
    # Apache's settings, and since we're behind a proxy (k8s ingress), the
    # actual scheme for communication between ingress and this apache is http,
    # which is what mellon sees.
    #
    # To make mod_auth_mellon operate correctly, apparently we need to add the
    # "https://" prefix to the server name directive.
    #
    # Source:
    # https://github.com/UNINETT/mod_auth_mellon/issues/66
    #
    ServerName https://tools.dev.aokranj.com

    DocumentRoot /data/ao-dev/tools.dev.aokranj.com/public



    # Authentication
    <Location />
        Require                 valid-user

        AuthType                mellon
        MellonEnable            auth
        MellonEndpointPath      /auth/sso/saml/
        MellonSPMetadataFile    /etc/apache2/sites-enabled/tools.dev.aokranj.com.saml-sp-metadata.xml
        # SPPrivateKey: Fake, not actually needed, it's just mellon complaining for no good reason
        MellonSPPrivateKeyFile  /etc/apache2/sites-enabled/tools.dev.aokranj.com.saml-sp-privkey.pem
        MellonIdPMetadataFile   /etc/apache2/sites-enabled/tools.dev.aokranj.com.saml-idp-metadata.xml

        MellonVariable          tools-dev-aokranj-com-saml-sessionid
        MellonSecureCookie      on
        # This one must be switched from "strict" to "none" for the behind-the-ingress setup to work
        MellonCookieSameSite    none
    </Location>



    # Apache-provided services
    <Location "/server-info">
        SetHandler server-info
        Require all granted
    </Location>

    <Location "/server-status">
        SetHandler server-status
        Require all granted
    </Location>
</VirtualHost>
